---
title: "LDP_LD"
author: "Yawen Yu and Dan Yurovsky"
date: "12/5/2017"
output:
  html_document: default
  pdf_document: default
---

```{r, load data, message=FALSE, results='hide', warning=FALSE, echo=FALSE}
## Library required packages
library(koRpus)
library(tidyverse)
library(tm)
library(lme4)
library(dplyr)
library(feather)
library(sjPlot)
```


```{r, eval=FALSE, message=FALSE, results='hide', echo=FALSE}
#### Load and Clean Data
# Read in LDP data
ldp <- src_sqlite("/Users/Yawen/Desktop/lexical diversity/trial5_ldp/ldp.db")

# Get all utterances
utter <- tbl(ldp, "utterances") %>%
  collect() 

# Get all participants
subjs <- tbl(ldp, "subjects") %>%
  collect() %>%
  rename(subject = id)

# Get visit data
visits <- tbl(ldp, "visits") %>%
  collect() %>%
  select(subject, session, date, child_age, child_age_years, child_age_months,
         income)

# Get measures data
measures <- tbl(ldp, "measures") %>%
  collect() %>%
  select(-last_update) %>%
  left_join(y=visits, by = c("subject", "session")) %>%
  mutate(ttr = word_types/word_tokens) 

# remove unintelligible utterances
murmur = c("xxx", "yyy", "yyy_yyy","---")
utter_clean <- utter %>%
  filter(!c_utts %in% murmur) %>%
  mutate(c_utts = removeWords(c_utts, murmur),
         c_utts = gsub("[^[:alnum:]]", " ", c_utts)) %>%
  filter(!grepl("^\\s*$", c_utts)) 


#### Notice: Age column is NOT completely coded, but Session column is complete
# complete missing Age data according to Session data
session_80 <- visits %>%
  filter(session > 12) %>%
  mutate(age = round(mean(child_age_months))) %>%
  select("session", "age") %>%
  unique(.)

session_age <- measures %>%
  select("session", "child_age_months") %>%
  mutate(child_age_months = round(child_age_months)) %>%
  rename(age = child_age_months) %>%
  unique(.) %>%
  head(n=12) %>%
  rbind(session_80)

# collapse utterances at one month to one row
utter_collapsed <- utter_clean %>%
  filter(subject == subject) %>%
  filter(session == session) %>%
  group_by(subject, session) %>%
  summarise(utts = paste0(c_utts, collapse = " ")) 

# keep only complete rows
utter_tokenize <- utter_collapsed[complete.cases(utter_collapsed),] %>%
                        split(paste0(.$subject, "-", .$session, "-"))  

```


```{r, message=F, eval=F, echo=F}
# Measure Lexical Diversity
##### TTR is not very informative
measures %>%
  filter(speaker == "C") %>%
  ggplot(aes(x=session, y=ttr)) +
  geom_smooth(se = F) +
  theme_classic()

# measure LD with MTLD
tokenize_mtld <- function(df) {
  tokenized_df <- koRpus::tokenize(df$utts, format = "obj", lang = "en", tag = TRUE) #tokenize texts
  MTLD <- MTLD(tokenized_df) # measure LD
  mtld <- data_frame(mtld = MTLD@MTLD$MTLD) # get LD measurement
  length <- data_frame(length = MTLD@tt$num.tokens)  # get length meaasurement
  merge(x = length,y = mtld, by = NULL) # combine LD and lenghth values
}

# measure and filter accurate data
utter_ld <- map(utter_tokenize, tokenize_mtld)%>% 
  bind_rows(.id = "id") %>%
  separate(col = id, into = c("subject", "session"), sep = "-") %>%
  mutate(subject = as.integer(subject),
         session = as.integer(session)) %>%
  filter(!mtld == as.numeric("inf")) %>%
  filter(!length < 100) # MTLD yield inaccurate results when utterance length <100 words

# filter kids' data with more than 2 observeations
mtld_filter <- function(df) {
  nmtld <- aggregate(df$mtld,
  by = list(subject = df$subject),length)
 
   nchild <- nmtld$subject[(nmtld$x > 5)]
  
  df <- df %>%
  filter(subject %in% nchild) %>%
  group_by(subject)
  
  return(df)
}


filter_data <- mtld_filter(utter_ld) 


# Measure Mother's Lexical Diversity
# remove unintelligible utterances
utter_mom <- utter %>%
  filter(!p_utts %in% murmur) %>%
  mutate(p_utts = removeWords(p_utts, murmur),
         p_utts = gsub("[^[:alnum:]]", " ", p_utts)) %>%
  filter(!grepl("^\\s*$", p_utts)) %>%
  select(subject, session, p_utts)%>%
  left_join(x=session_age, by = c("session")) 

# collapse each month's utterances to one row
mom_col <- utter_mom %>%
  group_by(subject, session, age) %>%
  summarise(utts = paste0(p_utts, collapse = " "))

# keep only complete rows
mom_tok <- mom_col[complete.cases(mom_col),] %>%
  split(paste0(.$subject, "-", .$session, "-", .$age))  

mom_ld <- map(mom_tok, tokenize_mtld)%>% 
  bind_rows(.id = "id") %>%
  separate(col = id, into = c("subject", "session"), sep = "-") %>%
  mutate(subject = as.integer(subject),
         session = as.integer(session)) %>%
  filter(!mtld == as.numeric("inf")) %>%
  filter(!length < 100) 

mom_data <- mtld_filter(mom_ld)


# merge data
complete_data <- filter_data %>%
  left_join(y = mom_data,by = c("subject", "session")) %>%
  rename(kid_mtld = mtld.x,
         kid_length = length.x,
         mom_mtld = mtld.y,
         mom_length = length.y) %>%
  left_join(y = session_age, by = c("session")) %>%
  left_join(y = subjs, by = c("subject")) %>%
  filter(lesion == "",
         !age == 138) %>% ## keep data of typically-developing children
  left_join(visits) %>%
  group_by(subject) %>%
  mutate(income = replace(income, is.na(income), floor(mean(income, na.rm = T))))  %>%
  ungroup(.) %>%
  filter(complete.cases(.)) %>%
  mutate(race = factor(race, levels = c("WH", "BL", "2+"))) %>%
  mutate(sex = factor(sex, levels = c("M", "F"))) %>%
  select(subject, session, age, kid_length, kid_mtld, mom_length, mom_mtld, sex, race, ethn, income)


# write data to disk
write_feather(filter_data, 
              "/Users/Yawen/Desktop/lexical diversity/trial5_ldp/filter_data.feather")
write_feather(mom_data, 
              "/Users/Yawen/Desktop/lexical diversity/trial5_ldp/mom_data.feather")
write_feather(complete_data, 
              "/Users/Yawen/Desktop/lexical diversity/trial5_ldp/complete_data.feather")
```


#### Model 1: Growth Trajectory
```{r, message=F, results='hide'}
complete_data <- 
  read_feather("/Users/Yawen/Desktop/lexical diversity/trial5_ldp/complete_data.feather")


# Model1: child's lexical diversity of each session as response
age_model <- lmer(kid_mtld ~ 1 + log(age) + 
                    (1+log(age)|subject), data = complete_data)

Model1 <-age_model
sjt.lmer(Model1, show.header = TRUE, string.est = "Estimate", 
         string.ci = "Conf. Int.", string.p = "p-value",
         string.dv = "Response", string.pred = "Coefficients",
         p.numeric = F)


# get kid's slope based on Model1
fixed_effects <- fixef(Model1) 
ran_effects <- as_data_frame(ranef(Model1)$subject) 
kid_effects <-  ran_effects %>%
  mutate(subject = as.integer(rownames(ran_effects)),
         kid_slope = `log(age)` + fixed_effects[2]) %>%
  select(subject, kid_slope)


# plot predicted lexical diversity growth 
predict_data <- complete_data %>%
  mutate(predicted = predict(Model1, newdata =.)) 

ggplot()+
  geom_smooth(aes(x = age, y = mom_mtld, 
                  color = "observed mother's data"),se = FALSE, data = predict_data)+
  geom_smooth(aes(x=age, y=kid_mtld, 
                  color = "observed child's data"),se = FALSE, data = predict_data)+
  geom_smooth(aes(x=age, y=predicted, 
                  color = "predicted child's data"),se = FALSE, data = predict_data)+
  labs(title = "Childrens' and Mothers' Lexical Diversity Growth", 
       subtitle = "0 ~ 58 Months")+
  theme_classic() +
  ylab("Lexical Diversity")+
  xlab("Age (month)")
```


#### Get Estimated Intercept 
```{r, modeling, message=FALSE, echo=F, results='hide'}
# Child's predicted mtld value at 20 month as intercept
kid_data <- kid_effects %>%
  mutate(age = 20)%>%
  mutate(kid_intercept = predict(Model1, newdata = .)) %>%
  select(-c(age))

# predict mother's intercept at 20 month  
mom_slope_model <- lmer(mom_mtld ~  1+ log(age) 
                        + (1 + log(age)|subject), data = complete_data)

mom_fix <- fixef(mom_slope_model) 
mom_random <- as_data_frame(ranef(mom_slope_model)$subject) 
mom_effects <-  mom_random %>%
  mutate(subject = as.integer(rownames(mom_random)),
         mom_slope = `log(age)` + mom_fix[2]) %>%
  select(subject, mom_slope) %>%
  mutate(age = 20) %>%
  mutate(mom_intercept = predict(mom_slope_model, newdata = .))  %>%
  select(-c(age))


# combine data
all_data <- kid_data %>%
  left_join(mom_effects) %>%
  left_join(complete_data) %>%
  group_by(subject, kid_slope, kid_intercept, 
           mom_slope, mom_intercept, race, sex, ethn) %>%
  summarise(income = mean(income)) 

month_data <- complete_data %>%
  left_join(select(all_data, subject, mom_slope, mom_intercept))  

```  


#### Model2: Child Intercept as Repsonse
```{r, message=F, results='hide', echo=F}
null <- lm(kid_intercept ~ 1 , data = all_data)
full <- lm(kid_intercept ~ mom_slope + mom_intercept + 
             sex + race + income, data = all_data)
stats::step(null, scope=list(lower=null, upper=full), direction="both", na.rm = TRUE)
```
```{r, message=F}
## summarize model
summary(lm(kid_intercept ~ mom_slope + mom_intercept,  data = all_data))

```

  
#### Model3: Child's Slope as Response
```{r, message=F, results='hide', echo=F}
null2 <- lm(kid_slope ~ 1, data = all_data)
full2 <- lm(kid_slope ~ kid_intercept + mom_slope + 
              mom_intercept + sex + race + income, data = all_data)
stats::step(null2, scope=list(lower=null2, upper=full2), direction="both", na.rm = TRUE)
```
```{r, message=F}
# mother's language  
summary(lm(kid_slope ~ mom_intercept + mom_slope, data = all_data))

# mother's language + income
summary(lm(kid_slope ~  mom_intercept  + mom_slope+ income + kid_intercept, data = all_data))
```


#### Model 4: Mother's intercept as Response
```{r, message=F, results='hide', echo=F}
# Mothers talk differently to boys and girls
null3 <- lm(mom_intercept ~ 1 , data = all_data)
full3 <- lm(mom_intercept ~ kid_slope + kid_intercept + 
              sex + race + income, data = all_data)
stats::step(null3, scope=list(lower=null3, upper=full3), direction="both", na.rm = TRUE)
```
```{r, message=F}
# summarize Model 
summary(lm(mom_intercept ~ kid_slope + sex + race, data = all_data))

```


### Effect of Maternal Speech
```{r, message=F}
# General growth trajectory varies by mother's diversity of speech
month_data %>%
  ungroup(.) %>% 
  mutate(rank = ifelse(mom_intercept <= quantile(mom_intercept, probs=c(0.30)), 0, 
                       ifelse(mom_intercept <= quantile(mom_intercept, probs=c(0.60)), 1,2)),
         rank = as.factor(rank)) %>%
  group_by(subject) %>%
  ggplot(.,aes(x=age, y=kid_mtld, color=rank))+
  geom_smooth(se=F)+
  theme_classic()


# variation related with mother's language
summary(lm(kid_mtld ~ mom_intercept + mom_slope, data = month_data))

# related to mother's language and income
summary(lm(kid_mtld ~ mom_intercept + mom_slope + income, data = month_data))

summary(lm(scale(kid_mtld) ~ scale(mom_slope) + scale(mom_intercept) + 
                     (income > median(income)), data = month_data))
```  
