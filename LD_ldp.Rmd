---
title: "LDP_LD"
author: 'Yawen Yu and Dan Yurovsky'
date: "12/5/2017"
output: pdf_document
---
## Clean Data
```{r, clean data, results='hide', message=FALSE}
# remove unintelligible utterances
murmur = c("xxx", "yyy", "yyy_yyy","---")
utter_clean <- utter_data %>%
  filter(!c_utts %in% murmur) %>%
  mutate(c_utts = removeWords(c_utts, murmur),
         c_utts = gsub("[^[:alnum:]]", " ", c_utts)) %>%
  filter(!grepl("^\\s*$", c_utts)) %>%
 left_join(participant, by=c("subject","session"))

# collapse each kid's utterances every month to one row
utter_collapsed <- utter_clean %>%
  mutate(age = round(child_age_months)) %>%
  filter(subject == subject) %>%
  filter(session == session) %>%
  group_by(subject, session, age) %>%
  summarise(utts = paste0(c_utts, collapse = " ")) %>%
  filter(!is.na(age)) %>%
  filter(age != 0)

# keep only complete rows
utter_tokenize <- utter_collapsed[complete.cases(utter_collapsed),] %>%
                        split(paste0(.$subject, "-", .$session, "-", .$age))  

```

## Measure Lexical Diversity
```{r,measure lexical diversity, results='hide', message=FALSE}
# measure LD 
### create a function to measure lexical diversity(LD)
tokenize_mtld <- function(df) {
  tokenized_df <- koRpus::tokenize(df$utts, format = "obj", lang = "en", tag = TRUE) #tokenize texts
  MTLD <- MTLD(tokenized_df) #measure LD
  mtld <- data_frame(mtld = MTLD@MTLD$MTLD) #get LD measurement
  length <- data_frame(length = MTLD@tt$num.tokens)  #get length meaasurement
  merge(x = length,y = mtld, by = NULL) #combine LD and lenghth values
}

### measure and filter accurate data
utter_ld <- map(utter_tokenize, tokenize_mtld)%>% 
  bind_rows(.id = "id") %>%
  separate(col = id, into = c("subject", "session", "age"), sep = "-") %>%
  mutate(subject = as.integer(subject),
         session = as.integer(session),
         age = as.numeric(age)) %>%
  filter(!mtld == as.numeric("inf")) %>%
  filter(!length < 100) # MTLD yield inaccurate results when utterance length <100 words

### create a function to filter kids with more than 2 observeations
mtld_filter <- function(df) {
  nmtld <- aggregate(df$mtld,
  by = list(subject = df$subject),
  length)
  nchild <- nmtld$subject[(nmtld$x > 2)]
  df <- df %>%
  filter(subject %in% nchild) %>%
  group_by(subject)
}

filter_data <- mtld_filter(utter_ld)

### 110 kids in total
id <- unique(filter_data$subject)

# measure mothers' speech
mom_ld <- map(mom_tok, tokenize_mtld)%>% 
  bind_rows(.id = "id") %>%
  separate(col = id, into = c("subject", "session", "age"), sep = "-") %>%
  mutate(subject = as.integer(subject),
         session = as.integer(session),
         age = as.numeric(age)) %>%
  filter(!mtld == as.numeric("inf")) %>%
  filter(!length < 100) 

### get moms' mean and_slope 
mom_mean <- mom_ld %>%
  group_by(subject) %>%
  mutate(mean = mean(mtld)) %>%
  select("subject", "mean")

mean_value <- distinct(mom_mean) %>%
  mutate(mean = as.numeric(mean))

mom_slope_model <- lmer(mtld ~ log(age) + (log(age)|subject), data=mom_ld)
fix_mom <- fixef(mom_slope_model)
mom_slope <- data.frame(slope= ranef(mom_slope_model)$subject[2] + fix_mom[2])
mom_slope <- mom_slope %>%
  mutate(subject = row.names(mom_slope))
mom_slope <-  merge(mean_value, mom_slope, by = c("subject"))
colnames(mom_slope) <- c("subject","mean","slope")

### combine children and mother data
combine_data <- merge(filter_data, mom_slope,by = c("subject"))
```


## Recode Time
```{r}
# take mean age (39.82 month) as initial session
mean_age <- combine_data %>%
  mutate(log_age = log(age)) %>%
  ungroup() %>%
  summarise(log_age = mean(log_age)) %>%
  mutate(age = exp(log_age))

recode_data <- combine_data %>%
  mutate(log_age = log(age),
         recode_age = log_age - mean(log_age)) 

### get kids' intercept 
recode_age_model <- lmer(mtld ~ recode_age + (recode_age|subject), data = recode_data)

fixed_effects <- fixef(recode_age_model) 

kid_effects <- as_data_frame(ranef(recode_age_model)$subject) 

kid_effects <-  kid_effects %>%
  mutate(subject = rownames(kid_effects),
         mean_age_intercept = `(Intercept)` + fixed_effects[1],
         kid_slope = recode_age + fixed_effects[2]) %>%
  select(-one_of(drop))

### combine kids' and moms' data (y stands for kids, x mom)
recode_combine <- recode_data %>%
  merge(x = kid_effects, by=c("subject")) %>%
  merge(x = mom_ld, by = c("subject","session","age")) %>%
  group_by(subject)  %>%
  mutate(mom_lag = lag(mtld.x, n=6),
         kid_lag = lag(mtld.y, n=6)) %>%
  rename(mom_mean = mean, 
         mom_slope = slope,
         kid_mtld = mtld.y,
         mom_mtld = mtld.x,
         kid_length = length.y,
         mom_length = length.x)

# plot MTLD growth with age
ggplot()+
  geom_smooth(aes(x=age, y=mom_mtld, colour = "mother"), data = recode_combine)+
  geom_smooth(aes(x=age, y=kid_mtld, colour = "children"), data = recode_combine)+
    labs(title = "Childrens' and Mothers' Lexical Diversity Growth", subtitle = "0 ~ 300 Months") +
  theme_classic() +
  ylab("Lexical Diversity")+
  xlab("Age (month)")
```


## Model Growth Curve
```{r, modeling, message=FALSE}
# Model1: predictors of kids' lexical diversity
simple_model <- lmer(kid_mtld ~ recode_age + (recode_age|subject), data = recode_combine)
mean_model <- 
  lmer(kid_mtld ~ recode_age + mean_age_intercept + (recode_age|subject), data = recode_combine)
anova(simple_model, mean_model) # kid's intercept at mean age  

slope_model <- 
  lmer(kid_mtld ~ recode_age + mean_age_intercept + kid_slope + (recode_age|subject), 
       data = recode_combine)
anova(mean_model, slope_model) 

mean_mom_model <- 
  lmer(kid_mtld ~ recode_age + mean_age_intercept + mom_mean + (recode_age|subject), 
       data = recode_combine)
anova(mean_model,mean_mom_model) 

slope_mom_model <- 
  lmer(kid_mtld ~ recode_age + mean_age_intercept + mom_slope + (recode_age|subject), 
       data = recode_combine)
anova(mean_model,slope_mom_model) 

### summary Model1
Model1 <- mean_model
summary(Model1)
#### Finding: Kids' LD is mainly explained by their age and mean_age_intercept

### save and plot the fitted values of optimal model
recode_combine$predict_data <- fitted(Model1)

recode_combine %>%
  filter(age < 200) %>%
  ggplot()+
  geom_point(aes(x=age, y=kid_mtld))+
  geom_smooth(aes(x=age, y=kid_mtld, colour = "observed data"))+
  geom_smooth(aes(x=age, y=predict_data, colour = "predicted data"))+
  theme_classic()
 

# Model2: predictors of kid's mean_age_intercept
simple_model2 <- 
  lm(mean_age_intercept ~ 1, data = recode_combine)
age_model <- 
  lm(mean_age_intercept ~ age, data = recode_combine)
anova(simple_model2, age_model) 

mean_model <-
  lm(mean_age_intercept ~ mom_mean, data = recode_combine)
anova(simple_model2, mean_model) # mom's mean LD
  
slope_model <-
  lm(mean_age_intercept ~ mom_mean + mom_slope, data = recode_combine)
anova(mean_model, slope_model) # slope of kid's LD
  
slope_kid_model <-
  lm(mean_age_intercept ~ mom_mean + mom_slope + kid_slope, data = recode_combine)
anova(slope_model, slope_kid_model) # slope of mom's LD
  
length_model <-
  lm(mean_age_intercept ~ mom_mean + mom_slope + kid_slope + kid_length,
  data = recode_combine)
anova(slope_kid_model, length_model) # length of kids' utterances
  
length_mom_model <- lm(mean_age_intercept ~ mom_mean + mom_slope + 
                         kid_slope + kid_length + mom_length,
  data = recode_combine)
anova(length_model, length_mom_model) 

### summary Model2
Model2 <- length_model
summary(Model2)
#### Finding: Kid's intercept at mean age(39.2mon) can be partially explained 
#### by mom's speech and length of kids' utterances


# test lagged correlation (n=6)
lag_model <- lm(mom_mtld ~ log(age) + kid_lag, data = recode_combine)
lag_model2 <- lm(kid_mtld ~ log(age) + mom_lag, data = recode_combine)
summary(lag_model)
summary(lag_model2)
#### Finding: mother's speech better predict variations of children's speech in 6 months 
```


## Correlation of mother's speech and kid's LD
```{r, message=FALSE}
# gather kids' intercept for every age that is coded as the origin of time
#### Note: kid's slope is the same for any age as the initial session
time_table <- unique(combine_data$age)
time_table <- time_table[order(time_table)] 

recode_age_combine <- mom_slope %>%
  rename(mom_mean = mean, mom_slope = slope)

# recode time  
for(i in (1:68)){
recode_data <- combine_data %>%
  mutate(recode_age = log(age) - log(time_table[i]))

recode_all_model <- lmer(mtld ~ recode_age + (recode_age|subject), data = recode_data)
all_fixed <- fixef(recode_all_model) 
all_effects <- as_data_frame(ranef(recode_all_model)$subject) 

drop <- c("(Intercept)","recode_age")
all_effects <-  all_effects %>%
  mutate(subject = rownames(all_effects),
         age = `(Intercept)` + all_fixed[1]) %>%
  select(-one_of(drop))

colnames(all_effects)[[2]] <- paste(names(all_effects)[[2]], c(time_table[[i]]),sep = "")

recode_age_combine <- merge(x = recode_age_combine, y = all_effects, by = c("subject"))} 


# examine correlation with moms' mean and slope
cor_mean <- function(x){
  cor_model <- lm(x ~ mom_mean, data = recode_age_combine)
  cor_data <- as.data.frame(confint(cor_model, 'mom_mean', level=0.95))
  return(cor_data)
} 

cor_slope <- function(x){
  cor_model <- lm(x ~ mom_slope, data = recode_age_combine)
  cor_data <- as.data.frame(confint(cor_model, 'mom_slope', level=0.95))
  return(cor_data)
} 

### create dataframe: correlations between kids' LD intercept and moms' mean/slope
cor_mean_data <- do.call(rbind, lapply(recode_age_combine[,4:71], cor_mean))
cor_mean_data <- cor_mean_data %>%
  rename(lower = `2.5 %`, upper = `97.5 %`) %>%
  mutate(age = c(time_table),
         mean = (lower+upper)/2)


cor_slope_data <- do.call(rbind, lapply(recode_age_combine[,4:71], cor_slope))
cor_slope_data <- cor_slope_data %>%
  rename(lower = `2.5 %`, upper = `97.5 %`) %>%
  mutate(age = c(time_table),
         slope = (lower+upper)/2)


# CI plot of correlation
ggplot() + 
  geom_errorbar(data=cor_mean_data, mapping=aes(x=age, ymin=lower, ymax=upper), width=0.5, size=1, color="navy")+
  geom_point(data=cor_mean_data, mapping=aes(x=age, y=mean), size=1, shape=21, fill="white") +
  theme_classic() +
  ylab("Relationship of Child's LD to Mother's Mean LD") +
  xlab("Recoded Age (month) as Initial Session") 


ggplot() + 
  geom_errorbar(data=cor_slope_data, mapping=aes(x=age, ymin=lower, ymax=upper), width=0.5, size=1, color="navy")+
  geom_point(data=cor_slope_data, mapping=aes(x=age, y=slope), size=1, shape=21, fill="white") +
  theme_classic() + 
  ylab("Relationship of Child's LD to Mother's LD Slope") +
  xlab("Recoded Age (month) as Initial Session") 
#### Finding: the predictive relationship between mother's speech and kid's LD 
#### increases steadily with age, so does variation
```
