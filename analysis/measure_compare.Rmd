---
title: "Compare LD Indices"
author: "Yawen Yu and Dan Yurovsky"
date: '`r Sys.Date()`'
output:
html_document: null
pdf_document: default
toc: no
number_sections: no
theme: lumen
code_folding: hide
toc_float: no
---
```{r, message=FALSE, warning=FALSE}
library(stringr)
library(feather)
library(koRpus)
library(tidyverse)
library(lme4)
library(dplyr)
library(sjPlot)
library(corrplot)
library(tidytext)
library(childesr)
```


```{r, message=F, warning=F}
# Load data
ldp_all <- read_feather(here("data/ldp_all.feather"))%>%
           filter(session != 80)
```

* Plot Growth Curve
```{r}
# compare with CDI 
ldp_all%>%
        filter(age >=14 & age <=30)%>%
        group_by(subject)%>%
        ggplot()+
        geom_smooth(aes(x=age,y=scale(k_ttr), color="ttr"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_mattr), color="mattr"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_vocd), color="vocd"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_mtld), color="mtld"), se=F)+
        geom_smooth(aes(x=age, y=scale(k_cdi), color="CDI"),se=F)+
        geom_smooth(aes(x=age,y=scale(k_mlu), color="mlu"), se=F)+
        theme_classic()+
        labs(title = "Compare Lexical Diversity Indices with CDI", 
             subtitle = "LDP: 14 ~ 30 Months",
             y = "lexical diversity (scaled)")


# compare with PPVT 
ldp_all%>%
        filter(age >=30 & age <=58)%>%
        group_by(subject)%>%
        ggplot()+
        geom_smooth(aes(x=age,y=scale(k_ttr), color="ttr"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_mattr), color="mattr"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_vocd), color="vocd"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_mtld), color="mtld"), se=F)+
        geom_smooth(aes(x=age, y=scale(ppvt), color="PPVT"),se=F)+
        geom_smooth(aes(x=age,y=scale(k_mlu), color="mlu"), se=F)+
        theme_classic()+
        labs(title = "Compare Lexical Diversity Indices with PPVT", 
             subtitle = "LDP: 30 ~ 53 Months",
             y = "lexical diversity (scaled)")


# TTR vs MATTR
ldp_all %>%
        ggplot()+
        geom_smooth(aes(x=age,y=scale(k_ttr), color="ttr"), se=F)+
        geom_smooth(aes(x=age,y=scale(k_mattr), color="mattr"), se=F)+
        theme_classic()+
        labs(title = "Children's Growth Curve by TTR & MATTR",
             subtitle = "LDP: 14 ~ 58 Months",
             y = "lexical diversity (scaled)")


# MTLD vs vocd-D (Kid)
ldp_all %>%
        ggplot()+
        geom_smooth(aes(x=age,y=k_vocd, color="vocd"), se=F)+
        geom_smooth(aes(x=age,y=k_mtld, color="mtld"), se=F)+
        theme_classic()+
        labs(title = "Children's Growth Curve by MTLD & vocd-D",
             subtitle = "LDP: 14 ~ 58 Months",
             y = "lexical diversity (scaled)")

# MTLD vs vocd-D (Mother)
ldp_all %>%
        ggplot()+
        geom_smooth(aes(x=age,y=m_vocd, color="vocd"), se=F)+
        geom_smooth(aes(x=age,y=m_mtld, color="mtld"), se=F)+
        theme_classic()+
        labs(title = "Mother's Growth Curve by MTLD & vocd-D",
             subtitle = "LDP: 14 ~ 58 Months",
             y = "lexical diversity (scaled)")
```

* Get growth curve parameters
```{r, echo=F, message=F, warning=F}
# write a function geting growth curve parameters
get_params <- function(df) {
        
        model <- lmer(value ~ log(age) + ( log(age) | subject) ,
                      data = df)
        

        subj_effects <- as_data_frame(ranef(model)$subject, rownames = "subject")
        
        effects <- subj_effects %>%
                rename(intercept = `(Intercept)`,
                       slope = `log(age)`) %>%
                mutate(subject = as.numeric(subject)) %>%
                right_join(df %>% select(subject, person, measure) %>% distinct(.))
}

ldp_intercept <- ldp_all %>%
        rename(k_ppvt = ppvt,
               k_sen = sentence)%>%
        select(-c(income, race, sex, ethn, lesion, project, active, control, note)) %>%
        group_by(subject)%>%
        gather(measure, value, k_mtld:k_ppvt) %>%
        separate(measure, c("person", "measure"), "_") %>%
        split(paste0(.$person, "_", .$measure)) %>%
        map(get_params) %>%
        bind_rows(.id = "id") %>%
        select(-id)%>%
        filter(complete.cases(.))

write_feather(ldp_intercept, "/Users/Yawen/Documents/Github/CHILDES_Lexical-Diversity/data/ldp_intercept.feather")
```

* Variance 
```{r, message=F, warning=F}
ldp_intercept <- read_feather(here("data/ldp_intercept.feather"))

ldp_intercept %>%
        filter(person == "k")%>%
        gather(type, value, intercept, slope) %>%
        group_by(measure, type) %>%
        summarise(mean = mean(value, na.rm=TRUE),
                  sd = sd(value, na.rm=TRUE),
                  coef_of_var =sd/mean) #other way to report var?

ldp_intercept %>%
        filter(person == "m")%>%
        gather(type, value, intercept, slope) %>%
        group_by(measure, type) %>%
        summarise(mean = mean(value, na.rm=TRUE),
                  sd = sd(value, na.rm=TRUE),
                  coef_of_var =sd/mean)
```

* Correlation
```{r,message=F, warning=F}
#correlation of kid's intercepts
ldp_intercept %>%
        select(-slope)%>%
        group_by(subject,person, measure)%>%
        spread(measure, intercept)%>%
        filter(person == "k")%>%
        ungroup()%>%
        select(-person, -subject)%>%
        filter(complete.cases(.))%>%
        cor() %>%
        corrplot::corrplot(method = "number", type = "upper")

#correlation of kid's slope
ldp_intercept %>%
        select(-intercept)%>%
        group_by(subject,person, measure)%>%
        spread(measure, slope)%>%
        filter(person == "k")%>%
        ungroup()%>%
        select(-person, -subject)%>%
        filter(complete.cases(.))%>%
        cor() %>%
        corrplot::corrplot(method = "number", type = "upper")

#correlation between kid and caregiver
ldp_intercept %>%
        gather(type, value, intercept, slope) %>%
        filter(complete.cases(.))%>%
        spread(person, value) %>%
        group_by(measure, type) %>%
        summarise(cor = cor(k, m))
```