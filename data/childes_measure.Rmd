---
title: "childes_measure"
author: "Yawen Yu and Dan Yurovsky"
date: "2/22/2018"
output:
  html_document: default
  pdf_document: default
---
* library required packages
```{r, library, message=F,results='hide', warning=FALSE, echo=F}
# Library required packages
library(feather)
library(koRpus)
library(tidyverse)
library(tm)
library(lme4)
library(dplyr)
library(childesr)
library(sjPlot)
library(corrplot)
```

* get information of all participants 
```{r, message=FALSE, echo=FALSE}
participants <- get_participants(collection = NULL,
corpus = NULL, child = NULL, role = NULL)
```

* Clean Data and Assess Lexical Diversity 
```{r, eval=F, message=FALSE, echo=FALSE}
# get utterances 
utter <- get_utterances(
collection = NULL, corpus = NULL,
child = NULL, role = NULL) %>%
  filter(language == "eng")


# remove unintelligible utterances
murmur = c("xxx", "yyy", "yyy_yyy","---")

utter_kid <- utter %>%
  filter(speaker_code == "CHI") %>% 
  filter(!stem %in% murmur) %>%
  mutate(stem = removeWords(stem, murmur),
         stem = gsub("[^[:alnum:]]", " ", stem),
         stem = tolower(stem)) %>%
  filter(!grepl("^\\s*$", stem)) 

utter_p <- utter %>%
  filter(speaker_code == c("MOT","FAT")) %>%
  filter(!stem %in% murmur) %>%
  mutate(stem = removeWords(stem, murmur),
        stem = gsub("[^[:alnum:]]", " ", stem),
        stem = tolower(stem)) %>%
  filter(!grepl("^\\s*$", stem)) 
 

# collapse utterances of child at one month to one row
kid_collapsed <- utter_kid %>%
  filter(corpus_id == corpus_id) %>%
  filter(speaker_id == speaker_id) %>%
  filter(target_child_age == target_child_age) %>%
  filter(transcript_id == transcript_id) %>%
  group_by(corpus_id, speaker_id, target_child_age, transcript_id) %>%
  summarise(utts = paste0(stem, collapse = " ")) %>%
  mutate(age = floor(target_child_age/30.5)) %>%
  ungroup(.)%>%
  select(-target_child_age)%>%
  rename(corpus = corpus_id, subject = speaker_id,
         session = transcript_id) %>%
  filter(!subject == 5221) %>% # utterance is coded in an unintelligible way
  filter(!corpus %in% c(84,90,87,80,96,93))%>% # drop corpus of children with language disorder
  filter(!corpus %in% c(192,190,189,187,185,181,184,82)) # drop UK data

# write kid's speech to disk
write_feather(kid_collapsed, "/Users/Yawen/Desktop/
              lexical diversity/trial6_childes/kid_collapsed.feather")

# tokenize child's speech 
kid_tokenized <- kid_collapsed %>%  
  ungroup(.) %>%
  filter(complete.cases(.)) %>%
  split(paste0(.$corpus, "-",.$subject, "-", .$age, "-"))  
 

# tokenize utterances of caregiver 
p_tokenized <- utter_p %>%
  filter(corpus_id == corpus_id) %>%
  filter(transcript_id == transcript_id) %>%
  filter(target_child_age == target_child_age) %>%
  group_by(corpus_id, transcript_id, target_child_age) %>%
  summarise(utts = paste0(stem, collapse = " ")) %>%
  mutate(age = floor(target_child_age/30.5)) %>%
  select(-target_child_age) %>%
  rename(corpus = corpus_id, session = transcript_id) %>%
  left_join(select(kid_collapsed, corpus, subject, session, age)) %>%
  filter(!corpus %in% c(84,90,87,80,96,93))%>%
  filter(!corpus %in% c(192,190,189,187,185,181,184,82))%>%
  ungroup(.) %>%
  filter(complete.cases(.)) %>%
  split(paste0(.$corpus, "-",.$subject, "-", .$age, "-")) 
```

*Measure lexical diversity with MTLD
```{r}
# create functions to measure lexical diversity with MTLD
mtld_fun <- function(df) {
  tokenized_df <- koRpus::tokenize(df$utts, format = "obj", lang = "en", tag = TRUE) #tokenize texts
  MTLD <- MTLD(tokenized_df)# measure LD
  mtld <- data_frame(mtld = MTLD@MTLD$MTLD) # get LD measurement
  length <- data_frame(length = MTLD@tt$num.tokens)  # get length meaasurement
  merge(x = length,y = mtld, by = NULL) # combine LD and lenghth values
}


# measure speech of child and caregiver 
kid_mtld <- map(kid_tokenized, mtld_fun) %>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(!mtld == as.numeric("inf")) %>%
  filter(!length < 100) # MTLD yield inaccurate results if utterance length <100 words

p_mtld <- map(p_tokenized, mtld_fun) %>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(!mtld == as.numeric("inf")) %>%
  filter(!length < 100)

# filter kids' data with at least 5 observeations
mtld_filter <- function(df) {
  nld <- aggregate(df$mtld, by = list(subject = df$subject),length)
  nchild <- nld$subject[(nld$x > 4)]
  df <- df %>%
    filter(subject %in% nchild) %>%
    group_by(subject)
  return(df)
}

# merge data
mtld_data <- mtld_filter(kid_mtld) %>%
  left_join(y = mtld_filter(p_mtld), by = c("corpus", "subject", "age")) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  rename(kid_mtld = mtld.x,
         mom_mtld = mtld.y,
         kid_length = length.x,
         mom_length = length.y) 

write_feather(mtld_data, "/Users/Yawen/Desktop/
              lexical diversity/trial6_childes/mtld_data.feather")
```

*Measure lexical diversity with MATTR
```{r}
## create MATTR function
mattr_fun <- function(df) {
  tokenized_df <- koRpus::tokenize(df$utts, format = "obj", lang = "en", tag = TRUE) #tokenize texts
  MATTR <- MATTR(tokenized_df, window = 50)# measure LD
  mattr <- data_frame(mattr = MATTR@MATTR$MATTR) # get LD measurement
  length <- data_frame(length = MATTR@tt$num.tokens)  # get length meaasurement
  merge(x = length,y = mattr, by = NULL) # combine LD and lenghth values
}

# measure kid's speech
kid_mattr <- map(kid_tokenized, mattr_fun) %>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(!is.na(mattr)) %>%
  filter(!length < 100)


# measure parents' speech
p_mattr <- map(p_tokenized, mattr_fun) %>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(!mattr == as.numeric("inf")) %>%
  filter(!length < 100)


mattr_filter <- function(df) {
  nld <- aggregate(df$mattr, by = list(subject = df$subject),length)
  nchild <- nld$subject[(nld$x > 4)]
  df <- df %>%
    filter(subject %in% nchild) %>%
    group_by(subject)
  return(df)
}

# merge data
mattr_data <- mattr_filter(kid_mattr) %>%
  left_join(y = mattr_filter(p_mattr), by = c("corpus", "subject", "age")) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  rename(kid_mattr = mattr.x,
         mom_mattr = mattr.y,
         kid_length = length.x,
         mom_length = length.y)
  
mattr_50 <- mattr_filter(kid_mattr) %>%
  left_join(y = mattr_filter(p_mattr), by = c("corpus", "subject", "age")) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  rename(kid_mattr = mattr.x,
         mom_mattr = mattr.y,
         kid_length = length.x,
         mom_length = length.y)

# write kid data to disk
write_feather(mattr_data, "/Users/Yawen/Desktop/
              lexical diversity/trial6_childes/mattr_data.feather")
```

*Measure lexical diversity with vocd-D
```{r, message=F}
# create function to measure lexical diversity with VOCD-D
vocd_fun <- function(df) {
  tokenized_df <- koRpus::tokenize(df$utts, format = "obj", 
                                   lang = "en", tag = TRUE) #tokenize texts
  HDD <- HDD(tokenized_df)# measure LD
  vocd <- data_frame(vocd = HDD@HDD$HDD) # get LD measurement
  length <- data_frame(length = HDD@tt$num.tokens)  # get length meaasurement
  merge(x = length,y = vocd, by = NULL) # combine LD and lenghth values
}

# measure child's speech
kid_vocd <- map(kid_tokenized, vocd_fun)%>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(!vocd == as.numeric("inf"))%>%
  filter(!length < 100)


# measure parents' speech
p_vocd <- map(p_tokenized, vocd_fun) %>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(!vocd== as.numeric("inf")) %>%
  filter(!length < 100)

# filter child with more than 5 observations
filter_fun <- function(df) {
  nld <- aggregate(df$vocd, by = list(subject = df$subject),length)
  nchild <- nld$subject[(nld$x > 5)]
  df <- df %>%
    filter(subject %in% nchild) %>%
    group_by(subject)
  return(df)
}

vocd_data <- filter_fun(kid_vocd) %>%
  left_join(y = filter_fun(p_vocd), by = c("corpus", "subject", "age")) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  rename(kid_vocd = vocd.x,
         mom_vocd = vocd.y) %>%
  select(corpus, subject, age,kid_vocd, mom_vocd)


write_feather(vocd_data, "/Users/Yawen/Desktop/
              lexical diversity/trial6_childes/vocd_data.feather")
```

*Measure lexical diversity with TTR
```{r}
ttr_fun <- function(df) {
  tokenized_df <- koRpus::tokenize(df$utts, format = "obj", 
                                   lang = "en", tag = TRUE) #tokenize texts
  TTR <- TTR(tokenized_df)# measure LD
  rep <- data_frame(rep = TTR@TTR) # get LD measurement
  length <- data_frame(length = TTR@tt$num.tokens)  # get length meaasurement
  merge(x = length,y = rep, by = NULL) # combine LD and lenghth values
}


kid_rep <- map(kid_tokenized, ttr_fun)%>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(length >= 100)

mom_rep <- map(p_tokenized, ttr_fun)%>% 
  bind_rows(.id = "subject") %>%
  separate(col = subject, into = c("corpus","subject", "age"), sep = "-") %>%
  mutate(corpus = as.numeric(corpus),
         subject = as.numeric(subject),
         age = as.numeric(age)) %>%
  filter(length >= 100)


filter_fun <- function(df) {
  nld <- aggregate(df$rep, by = list(subject = df$subject),length)
  nchild <- nld$subject[(nld$x > 4)]
  df <- df %>%
    filter(subject %in% nchild) %>%
    group_by(subject)
  return(df)
}

ttr_data <- filter_fun(kid_rep)%>%
  left_join(y=filter_fun(mom_rep), by = c("corpus", "subject", "age")) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  rename(kid_ttr = rep.x,
         mom_ttr = rep.y,
         kid_length = length.x,
         mom_length = length.y) 

write_feather(ttr_data, "/Users/Yawen/Desktop/lexical diversity/trial6_childes/ttr_data.feather")
```