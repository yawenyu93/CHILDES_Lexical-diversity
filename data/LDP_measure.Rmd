---
title: "LDP_measure"
author: 'Yawen Yu and Dan Yurovsky'
date: '`r Sys.Date()`'
output:
pdf_document: default
html_document: null
toc: no
number_sections: no
theme: lumen
code_folding: hide
toc_float: no
---

* Library required packages 
```{r, load data, message=FALSE, results='hide', warning=FALSE, echo=FALSE}
library(koRpus)
library(tidyverse)
library(tm)
library(lme4)
library(dplyr)
library(feather)
library(sjPlot)
```

* Get LDP data
```{r, eval=FALSE, message=FALSE, results='hide', echo=FALSE}
#### Load and Clean Data
# Read in LDP data
ldp <- src_sqlite("/Users/Yawen/Desktop/lexical diversity/trial5_ldp/ldp.db")

# Get all utterances
utter <- tbl(ldp, "utterances") %>%
        collect() 

# Get all participants
subjs <- tbl(ldp, "subjects") %>%
        collect() %>%
        rename(subject = id)

# Get visit data
visits <- tbl(ldp, "visits") %>%
        collect() %>%
        group_by(subject) %>%
        mutate(income = replace(income, is.na(income), floor(mean(income, na.rm = T)))) %>%
        select(subject, session, income)

# Get measures data
measures <- tbl(ldp, "measures") %>%
        collect() %>%
        select(-last_update) %>%
        left_join(y=visits, by = c("subject", "session")) 
        
# complete missing Age data according to Session data
## because age column is NOT completely coded, but Session column is complete
session_age <- measures %>%
        select("session", "child_age_months") %>%
        mutate(child_age_months = floor(child_age_months)) %>%
        rename(age = child_age_months) %>%
        unique(.) %>%
        head(n=12)

write_feather(session_age,
              "/Users/Yawen/Desktop/lexical diversity/trial5_ldp/session_age.feather")
```

* Clean language data
```{r}
# remove unintelligible utterances
murmur = c("xxx", "yyy", "yyy_yyy","---")

utter_kid <- utter %>%
        filter(!c_utts %in% murmur) %>%
        mutate(c_utts = removeWords(c_utts, murmur),
               c_utts = gsub("[^[:alnum:]]", " ", c_utts),
               c_utts = tolower(c_utts)) %>%
        filter(!grepl("^\\s*$", c_utts)) %>%
        left_join(session_age)


# collapse utterances at one month to one row
utter_collapsed <- utter_kid %>%
        filter(subject == subject) %>%
        filter(session == session) %>%
        group_by(subject, session) %>%
        summarise(utts = paste0(c_utts, collapse = " ")) 

# keep only complete rows
kid_tokenized <- utter_collapsed[complete.cases(utter_collapsed),] %>%
        split(paste0(.$subject, "-", .$session, "-"))  

# Get Mother's speech
utter_mom <- utter %>%
        filter(!p_utts %in% murmur) %>%
        mutate(p_utts = removeWords(p_utts, murmur),
               p_utts = gsub("[^[:alnum:]]", " ", p_utts),
               p_utts = tolower(p_utts)) %>%
        filter(!grepl("^\\s*$", p_utts)) %>%
        select(subject, session, p_utts)%>%
        left_join(x=session_age, by = c("session")) 

# collapse each month's utterances to one row
mom_col <- utter_mom %>%
        group_by(subject, session, age) %>%
        summarise(utts = paste0(p_utts, collapse = " "))

# keep only complete rows
mom_tokenized <- mom_col[complete.cases(mom_col),] %>%
        split(paste0(.$subject, "-", .$session, "-", .$age)) 
```

* Measure lexical diversity
```{r}
# write a function utilizing target indices to measure lexical diversity
get_lex_div <- function(df){
        
        tokenized_df <- koRpus::tokenize(df$utts, format = "obj", lang = "en", tag = TRUE)
        
        MTLD <- MTLD(tokenized_df)#measure LD
        mtld <- data_frame(mtld = MTLD@MTLD$MTLD) #get LD measurement
        length <- data_frame(length = MTLD@tt$num.tokens)  #get length meaasurement
        
        MATTR <- MATTR(tokenized_df)
        mattr <- data_frame(mattr = MATTR@MATTR$MATTR) 
        
        HDD <- HDD(tokenized_df)
        vocd <- data_frame(vocd = HDD@HDD$HDD) 
        
        TTR <- TTR(tokenized_df)
        ttr <- data_frame(ttr = TTR@TTR) 
        
        all_ld <- mtld %>%
                merge(length)%>%
                merge(vocd)%>%
                merge(mattr)%>%
                merge(ttr)
       
}


kid_ld <- map(kid_tokenized, get_lex_div) %>%
        bind_rows(.id = "subject") %>%
        separate(col = subject, into = c("subject", "age"), sep = "-") %>%
        mutate(subject = as.numeric(subject),
               age = as.numeric(age)) %>%
        filter(length >=100)%>%
        filter(!mtld == as.numeric("Inf"))

mom_ld <- map(mom_tokenized, get_lex_div) %>%
        bind_rows(.id = "subject") %>%
        separate(col = subject, into = c("subject", "age"), sep = "-") %>%
        mutate(subject = as.numeric(subject),
               age = as.numeric(age)) %>%
        filter(length >=100)%>%
        filter(!mtld == as.numeric("Inf"))
```

* Get MLU data
```{r}
kid_mlu <- measures %>%
        filter(speaker == "C")%>%
        rename(k_mlu = mlu)%>%
        select(-c(income, protocol, speaker))

mom_mlu <- measures %>%
        filter(speaker == "P")%>%
        rename(m_mlu = mlu)%>%
        select(-c(income, protocol, speaker))
```

* Get PPVT&CDI data
```{r, echo=F, eval=F,message=F, warning=F}
# load LDP data
ldp_cdi <- read_csv("/Users/Yawen/Desktop/lexical diversity/trial5_ldp/cdi.csv")
ldp_ppvt <- read_csv("/Users/Yawen/Desktop/lexical diversity/trial5_ldp/ppvt.csv")

# filter children with at least 2 observations
filter_func <- function(df) {
        num <- aggregate(df$vocab,
                         by = list(subject = df$subject),length)
        nchild <- num$subject[(num$x > 1)]
        df <- df %>%
                filter(subject %in% nchild) %>%
                group_by(subject)
        return(df)
}


ldp_ppvt <- ldp_ppvt %>%
        rename(subject = `I Home Visit Info::subject_number`)%>%
        mutate(vocab = as.numeric(`ppvt_percentile`)) %>%
        filter_func(.)%>%
        select(-c(ppvt))%>%
        rename(k_ppvt = vocab)%>%
        select(subject, session, ppvt)


ldp_cdi <- ldp_cdi %>%
        rename(age = `cdis_subjectage`,
               subject = `I Home Visit Info::subject_number`,
               vocab = `Number of words`)%>%
        filter(!is.na(age))%>%
        filter_func(.)%>%
        mutate(sentence = as.numeric(`Sentence complexity`),
               session = ifelse(age <=16,1,
                                ifelse(age<=20,2,
                                       ifelse(age<=24,3,
                                              ifelse(age<=28,4,
                                                     ifelse(age<=32,5,
                                                            ifelse(age<=36,6,
                                                                   ifelse(age<=40,7))))))))%>%
        rename(k_cdi =vocab)%>%
        select(subject, session, k_cdi, sentence)
```  

* Merge data
```{r}
# filter kids' data with at least 5 observeations
measure_filter <- function(df) {
        nld <- aggregate(df$kid_mtld, by = list(subject = df$subject),length)
        nchild <- nld$subject[(nld$x > 4)]
        df <- df %>%
                filter(subject %in% nchild) %>%
                group_by(subject)
        return(df)
}

# combine CDI and PPVT with other datasets by `session`
ldp_all <- measure_filter(kid_ld) %>%
        left_join(measure_filter(mom_ld))%>%
        left_join(kid_mlu)%>%
        left_join(mom_mlu)%>%
        left_join(ldp_cdi,by =c("subject","session"))%>%
        left_join(ldp_ppvt)%>%
        left_join(session_age)%>%
        unique()%>%


write_feather(ldp_all,"/Users/Yawen/Desktop/lexical diversity/trial5_ldp/ldp_all.feather" )
```
